# 董杭杭的阿里云服务器配置笔记(踩坑记录) 2023.12

### 获取免费服务器

经过支付宝认证的高校学生，可以免费领阿里云的300元无门槛券，此优惠至2023.12.05仍然有效。

[领券及用券教程 (作者 b站up主：一只树莓吧)](https://www.bilibili.com/video/BV11N41137c7/)

[领券链接](https://university.aliyun.com/)

这个券，除了一些1折特价的服务器，全阿里云通用。但阿里云的服务器，要么1折，要么几乎不打折，导致这个优惠券很难用。

可以白嫖一个新加坡的服务器，一年，2核1G内存，30Mb带宽，40G硬盘。具体流程见上述视频。

### 服务器配环境 (Ubuntu 20.04)

#### 1. 密码、密钥和ssh

如果每次用服务器，都要点开阿里云网页，那也太愚蠢了。

因此，建议给自己的本地IDE接一个SSH，这样用起来就和本机/WSL没什么区别了。

SSH有两种登录方式：密码和密钥。

- 1.1 密码：登录非常简单，可以直接拿powershell输入：

```shell
ssh username@host_ip
# 例如：
ssh abc@1.2.3.4
```

按回车，等一下，然后再输入密码，即可登录SSH。

但它的缺点是，每次都得输入两次，先输入用户名再输入密码，配好了也不能无感使用。而且，用户名和密码经网络传输，可能被中间人攻击。
<br>

- 1.2 密钥：基于非对称加密，生成RSA公钥和私钥，公钥存于服务器上，私钥存于我自己电脑上，更加安全。

> 阿里云工作台可以生成一个用于root密钥，步骤是：轻量应用服务器，服务器，我的轻量，远程连接，密钥管理，新建密钥。创建后，私钥会自动下载。

私钥是一个`.pem`文件，它对安全要求非常严格，仅其所有者拥有读权限，其他所有用户(包括管理员)无权读、写、执行，否则密钥无法启用。

在Windows 11中，这样设置`.pem`文件的权限：

> 右键文件，属性，安全，高级，禁用继承（删除所有用户权限），添加，选择主体，输入自己的Windows用户名，确定，仅赋予读权限，确定，确定。

完成设置后，即可使用该密钥访问服务器。拿powershell输入：

```shell
ssh -i "C:\xxxxxxxxx\xxx.pem" username@host_ip
```

即可访问服务器。使用VS Code时，此命令可以自动写入配置文件，以后就可以全自动登录了。
<br>

- 1.3 虽然这样已经做到了全自动，但是，每次都登录root用户，有可能不小心修改了重要的东西，把系统搞炸。因此，建议新创一个有sudo权限的普通用户，比如叫做`newuser`，日常写代码，登录这个用户，只有必要时才进行sudo操作。

```shell
# 使用root用户运行：
useradd -m -s /bin/bash newuser
# -m：在/home目录下，为新用户开设文件夹。
# -s：指定新用户使用的shell，/bin/bash即为root使用的shell (Ubuntu 20.04)
# 附注：任何用户，bash输入history，可查看本用户使用bash的历史记录。

passwd newuser
# 为新用户设置密码，之后需要输入两次密码。

usermod -aG sudo newuser
# 将新用户添加到 sudo 组，以赋予管理员权限。
```

<br>

- 1.4 现在，新用户`newuser`已经创建好了，我们需要登录它。

但是，**登录并不容易**！

你想用密钥登录？阿里云最便宜的“轻量应用服务器”，只支持配置一个密钥给root用户。

你想用密码登录？由于密钥更安全，设置密钥后，阿里云服务器默认不再支持密码登录。(2023.12)

那该怎么办呢？这里比较绕，我的建议是：

- 首先，在`root`用户中，修改SSH配置文件，恢复使用密码登录。
- 然后，使用密码登录`newuser`用户，绕开阿里云，自行配置SSH公钥，支持密钥登录。
- 最后，修改SSH配置文件，禁止密码登录。

这样一来，以后就都可以用密钥登录`newuser`用户，无感，安全，还不容易用root权限误操作。

详细步骤如下所示。
<br>

- 1.5 想要恢复使用密码登录，根据[阿里云官方说明](https://help.aliyun.com/zh/simple-application-server/user-guide/connect-to-linux-server-remotely#section-kyx-w5p-3cg)，可以通过修改SSH配置文件实现：

```shell
sudo vim /etc/ssh/sshd_config
# 在vim中，按i进入编辑模式，然后在文件末尾，将PasswordAuthentication no修改为PasswordAuthentication yes
# esc :wq 回车 保存退出
sudo service sshd restart # 重启SSH服务
```

退出登录SSH：

```shell
logout
```

接下来，请用密码登录`newuser`用户。

<br>

- 1.6 自行配置SSH公钥

这一步，必须使用一个**新建的**用户，如`newuser`

> 在阿里云的Ubuntu 20.04镜像中，初始除了`root`用户，还有一个名为`admin`的用户，这个翻来覆去配不好，原因不明，建议直接把这个用户删了。

```shell
sudo pkill -u admin # 终止该用户的所有进程
sudo userdel -r admin # 删除该用户，及其邮件目录、/home下的主目录。
```

首先，在本地电脑中创建RSA密钥：

```shell
ssh-keygen -t rsa -C "newuser@mail.com" -f "C:\ProgramData\ssh\newuser"
# -t 使用的加密算法，一般是RSA
# -C 注释文字
# -f RSA密钥保存位置，将生成私钥文件newuser和公钥文件newuser.pem
# 运行此命令时，不能存在与"C:\ProgramData\ssh\newuser"名称相同的文件或文件夹。
```

然后，使用newuser用户运行，在服务器中运行：

```shell
cd ~
# 跳转到此用户的根目录，即/home/newuser

ls -a
# 列出所有子目录和文件，包括隐藏。此时newuser用户刚刚创建，应当没有.ssh文件夹。

mkdir .ssh  

touch .ssh/authorized_keys # 创建文件，authorized_keys文件记录了与本机通信过，可信的公钥。

vim .ssh/authorized_keys
# 把上面的公钥文件newuser.pem，复制到本地电脑的剪贴板中，在vim中按ctrl+v，粘贴到authorized_keys中，esc :wq 回车 保存退出。
# Windows 11的powershell可以这样粘贴，别的shell我没试过。

chmod 600 .ssh/authorized_keys
chmod 700 .ssh
# 与上面类似，设置严格的公钥文件访问权限。
```

上述命令参考了[这篇CSDN博客](https://blog.csdn.net/braveants/article/details/71747275)。

这样，就配置好了公钥。可以试试退出SSH，然后试着用密钥连接SSH。

如果一切顺利，即可修改SSH配置文件，禁止密码登录SSH，以后都用密钥登录。

- 1.7 使用VS Code

配置config文件，然后直接连接即可

```config
# "C:\Users\user\.ssh\config"
Host 1.2.3.4
    HostName 1.2.3.4
    User newuser
    IdentityFile C:\ProgramData\ssh\newuser # 此处输入上面创建的RSA私钥
```

>我用的VS Code，如果是JetBrain，需要学生认证，才能白嫖专业版，用SSH (但并不麻烦，建议尽快搞个学生认证)

#### 2. apt，Miniconda，git等

- 2.1 修改Linux主机名

阿里云默认的主机名，是一串很长的数字字母串，可以改短一点。

```shell
sudo hostnamectl set-hostname MyNewHostname
```

然后在阿里云服务器控制台上重启服务器，需要手机短信验证，可能得多等一会。

- 2.2 用apt更新系统软件

`apt`: linux的包管理工具，它保存有一个**软件源**（网络地址）。如果是内地服务器，建议换源为清华源或中科大源。
`apt update`：遍历本地的软件包列表，对于每一个包，从**软件源**获取其最新的软件包信息。（只保存软件包元数据，不更新包）
`apt upgrade`：根据`apt update`获取的最新软件包信息，下载并安装所有软件包的最新版本。

```shell
sudo apt update
sudo apt upgrade
```

如果这个过程中，新包和现有配置文件产生了冲突，建议保留现有配置文件。（直接选默认选项即可）。

> 我曾经选了新的，然后SSH炸了，登不上去。这个原理我没搞明白（摆了）最后重装系统了。

- 2.3 卸载系统自带的python

```shell
sudo apt-get remove python3

# 删除残留文件
sudo apt autoremove # 删除所有 不被其他软件包依赖 的apt软件包
sudo rm -r /etc/py*
sudo rm -r /usr/bin/py*
sudo rm -r /usr/lib/py*
sudo rm -r /usr/local/lib/py*
sudo rm -r /usr/share/py*
sudo rm -r /usr/share/man/man1/py*

# 检测卸载成功
python3 --version
```

上述命令参考了[这篇知乎专栏](https://zhuanlan.zhihu.com/p/129290782)。

- 2.4 安装Miniconda

Miniconda 貌似不能通过 apt安装，但可以使用官方sh脚本安装。

```shell
cd ~
mkdir tmp
cd tmp
# 下载.sh安装脚本
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
# 校验
sha256sum Miniconda3-latest-Linux-x86_64.sh 
```

校验下载好的sh脚本，请与[Miniconda官方文档](https://docs.conda.io/projects/miniconda/en/latest/)提供的sha256相比对。

```shell
mkdir ~/miniconda3
bash Miniconda3-latest-Linux-x86_64.sh -b -u -p ~/miniconda3
```

-b：在安装过程中使用批处理模式(Batch mode)，也就是说，安装过程中不会有任何交互，所有需要用户输入的地方都会使用默认值。

-u：如果在指定的安装位置已经存在一个Miniconda安装，那么就更新这个安装。如果没有指定这个选项，而安装位置已经存在一个Miniconda安装，那么安装脚本会失败。

-p 目录：安装Miniconda到指定目录。

```shell
# 删除.sh安装脚本
cd ~
rm -rf tmp/

# 设置conda自动运行（打开bash时，自动打开conda）
cd ~/miniconda3/bin
./conda init bash
logout
# 重新登录SSH，显示(base) newuser@hostname，即配置成功。
```

- 2.5 安装git

```shell
sudo apt-get install git

# 配置自己的用户名、密码
git config --global user.name "xxx"
git config --global user.email "xxx@xxx.com"
# 检验配置成功
git config --global --list
```

```shell
# 配置GitHub的SSH Key
ssh-keygen -t rsa -C "xxx@xxx.com"
cd ~/.ssh
cat id_rsa.pub
# 复制公钥，添加到GitHub
```

上述命令参考了[这篇CSDN博客](https://blog.csdn.net/braveants/article/details/71747275)。

之后，就可以用SSH的方式clone自己的GitHub仓库：`git@github.com:用户名/仓库名.git`

第一次使用SSH clone时，输入yes，保存GitHub服务器的ECDSA key。
